<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Paneli - TÃ¼m SonuÃ§lar</title>
  <link rel="stylesheet" href="common.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg, #e5e7eb);
      color: var(--text, #020617);
      margin: 0;
      padding: 24px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .badge-admin {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #1d4ed8;
      color: white;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }
    .top-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .pill-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      color: #111827;
      padding: 6px 14px;
      cursor: pointer;
      font-size: 13px;
    }
    .pill-btn:hover {
      background: #e5e7eb;
    }
    .filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .filter-row select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: white;
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      background: #f3f4f6;
      border-radius: 16px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #e5e7eb;
      font-weight: 600;
    }
    tr:nth-child(even) td {
      background: #f9fafb;
    }
    tr:nth-child(odd) td {
      background: #f3f4f6;
    }
    pre {
      margin: 0;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div>
        <h1>ðŸ“Š TÃ¼m Test SonuÃ§larÄ± <span class="badge-admin">Admin</span></h1>
        <div style="font-size:13px; color:#6b7280;">
          KullanÄ±cÄ± bazlÄ± tÃ¼m test skorlarÄ±nÄ± gÃ¶rÃ¼yorsunuz.
        </div>
        <div class="filter-row">
          <span>ðŸ”Ž KullanÄ±cÄ± filtresi:</span>
          <select id="userFilter">
            <option value="">TÃ¼m kullanÄ±cÄ±lar</option>
          </select>
        </div>
      </div>

      <div class="top-right">
        <button type="button" class="pill-btn" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </div>

    <table id="resultsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>KullanÄ±cÄ±</th>
          <th>Test AdÄ±</th>
          <th>SÃ¼re (sn)</th>
          <th>Skor</th>
          <th>DoÄŸru</th>
          <th>KaÃ§Ä±rma</th>
          <th>YanlÄ±ÅŸ Alarm</th>
          <th>Tarih</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="api.js"></script>
  <script>
    const API_BASE = 'http://localhost:4000';

    const rawUser = localStorage.getItem('currentUser');
    if (!rawUser) {
      window.location.href = 'index.html';
    }

    let currentUser;
    try {
      currentUser = JSON.parse(rawUser);
    } catch {
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    }

    if (currentUser.role !== 'admin') {
      window.location.href = 'test1.html';
    }

    function logout() {
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    }

    function formatDate(dt) {
      return new Date(dt).toLocaleString('tr-TR');
    }

    function formatTestName(raw) {
      switch (raw) {
        case 'test1':
          return 'Harf/SayÄ± Tepki Testi';
        case 'test2':
          return 'Ã‡ift GÃ¶rev Tepki Testi';
        case 'test3':
          return 'Åžekiller SÄ±ralama Testi';
        default:
          return raw || '-';
      }
    }

    
    function getDurationSec(r) {
      if (r.extra && typeof r.extra === 'object' && r.extra.durationSec != null) {
        return r.extra.durationSec;
      }
      return '-';
    }

   
    let ALL_RESULTS = [];

    
    function populateUserFilter() {
      const select = document.getElementById('userFilter');
      
      select.innerHTML = '<option value="">TÃ¼m kullanÄ±cÄ±lar</option>';

      const seen = new Map(); 

      ALL_RESULTS.forEach(r => {
        if (!seen.has(r.user_id)) {
          seen.set(r.user_id, {
            username: r.username,
            role: r.role || 'user'
          });
        }
      });

      for (const [userId, info] of seen.entries()) {
        const opt = document.createElement('option');
        opt.value = userId;
        opt.textContent = `${info.username} (${info.role})`;
        select.appendChild(opt);
      }
    }

    function renderTable(filterUserId = '') {
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';

      const rows = filterUserId
        ? ALL_RESULTS.filter(r => String(r.user_id) === String(filterUserId))
        : ALL_RESULTS;

      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="9">Bu filtrede sonuÃ§ bulunamadÄ±.</td></tr>';
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.username}</td>
          <td>${formatTestName(r.test_name)}</td>
          <td>${getDurationSec(r)}</td>
          <td>${r.score}</td>
          <td>${r.hits ?? '-'}</td>
          <td>${r.misses ?? '-'}</td>
          <td>${r.false_alarms ?? '-'}</td>
          <td>${formatDate(r.created_at)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadAdminResults() {
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '<tr><td colspan="9">YÃ¼kleniyor...</td></tr>';

      try {
        const res = await fetch(API_BASE + '/api/admin/all-results');
        if (!res.ok) {
          tbody.innerHTML = '<tr><td colspan="9">Veri alÄ±nÄ±rken hata oluÅŸtu.</td></tr>';
          console.error('Admin sonuÃ§ listesi hatasÄ±:', await res.text());
          return;
        }

        const data = await res.json();
        ALL_RESULTS = data.results ?? [];

        populateUserFilter();
        const currentFilter = document.getElementById('userFilter').value;
        renderTable(currentFilter);
      } catch (err) {
        console.error('Admin sonuÃ§ listesi hatasÄ±:', err);
        tbody.innerHTML = '<tr><td colspan="9">Sunucuya ulaÅŸÄ±lamadÄ±.</td></tr>';
      }
    }

    document.getElementById('userFilter').addEventListener('change', (e) => {
      const value = e.target.value;
      renderTable(value);
    });

    window.addEventListener('DOMContentLoaded', loadAdminResults);
  </script>
</body>
</html>
